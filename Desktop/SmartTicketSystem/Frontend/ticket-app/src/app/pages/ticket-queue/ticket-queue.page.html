<div class="page">
  <div class="header">
    <h1>{{ isManager() ? 'Ticket Queue Management' : 'My Queue' }}</h1>
    <p class="subtitle">{{ isManager() ? 'Assign and manage tickets' : 'Tickets assigned to you' }}</p>
    <button mat-raised-button color="primary" (click)="load()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
  </div>

  <!-- My Workload Section - Only for Support Agents -->
  <mat-card class="workload-card" *ngIf="!isManager() && myWorkload">
    <h2>My Workload</h2>
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-icon class="stat-icon total">assignment</mat-icon>
        <div class="stat-content">
          <div class="stat-value">{{myWorkload.totalAssigned}}</div>
          <div class="stat-label">Total Assigned</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <mat-icon class="stat-icon open">inbox</mat-icon>
        <div class="stat-content">
          <div class="stat-value">{{myWorkload.openTickets}}</div>
          <div class="stat-label">Open Tickets</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <mat-icon class="stat-icon progress">schedule</mat-icon>
        <div class="stat-content">
          <div class="stat-value">{{myWorkload.inProgressTickets}}</div>
          <div class="stat-label">In Progress</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <mat-icon class="stat-icon resolved">check_circle</mat-icon>
        <div class="stat-content">
          <div class="stat-value">{{myWorkload.resolvedTickets}}</div>
          <div class="stat-label">Resolved</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <mat-icon class="stat-icon time">access_time</mat-icon>
        <div class="stat-content">
          <div class="stat-value">{{myWorkload.averageResolutionTimeHours.toFixed(1)}}</div>
          <div class="stat-label">Avg Resolution (hrs)</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <mat-icon class="stat-icon workload">work</mat-icon>
        <div class="stat-content">
          <div class="stat-value">{{myWorkload.openTickets + myWorkload.inProgressTickets}}</div>
          <div class="stat-label">Current Workload</div>
        </div>
      </mat-card>
    </div>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filters">
    <mat-form-field appearance="outline">
      <mat-label>Status</mat-label>
      <mat-select [(value)]="filterStatus" (selectionChange)="filter()">
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let s of statuses" [value]="s.value">{{s.label}}</mat-option>
      </mat-select>
    </mat-form-field>
    
    <mat-form-field appearance="outline">
      <mat-label>Priority</mat-label>
      <mat-select [(value)]="filterPriority" (selectionChange)="filter()">
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let p of priorities" [value]="p.value">{{p.label}}</mat-option>
      </mat-select>
    </mat-form-field>
    
    <mat-form-field appearance="outline">
      <mat-label>Category</mat-label>
      <mat-select [(value)]="filterCategory" (selectionChange)="filter()">
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let c of categories" [value]="c.id">{{c.name}}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Manager: Filter by Assignment Status -->
    <mat-form-field appearance="outline" *ngIf="isManager()">
      <mat-label>Assignment</mat-label>
      <mat-select [(value)]="filterAssignment" (selectionChange)="filter()">
        <mat-option value="">All</mat-option>
        <mat-option value="unassigned">Unassigned</mat-option>
        <mat-option value="assigned">Assigned</mat-option>
      </mat-select>
    </mat-form-field>
    
    <button mat-raised-button (click)="clear()">
      <mat-icon>clear</mat-icon>
      Clear
    </button>
  </mat-card>

  <app-loading *ngIf="loading"></app-loading>

  <!-- Tickets Table -->
  <mat-card *ngIf="!loading">
    <table mat-table [dataSource]="tickets" class="queue-table">
      
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let t">#{{t.id}}</td>
      </ng-container>

      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>Title</th>
        <td mat-cell *matCellDef="let t">
          <a [routerLink]="['/tickets', t.id]">{{t.title}}</a>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let t">
          <app-status-badge [status]="t.status"></app-status-badge>
        </td>
      </ng-container>

      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef>Priority</th>
        <td mat-cell *matCellDef="let t">
          <app-priority-badge [priority]="t.priority"></app-priority-badge>
        </td>
      </ng-container>

      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>Category</th>
        <td mat-cell *matCellDef="let t">{{t.categoryName}}</td>
      </ng-container>

      <ng-container matColumnDef="createdBy">
        <th mat-header-cell *matHeaderCellDef>Created By</th>
        <td mat-cell *matCellDef="let t">{{t.createdByName}}</td>
      </ng-container>

      <!-- Assigned To Column - Show for Manager -->
      <ng-container matColumnDef="assignedTo">
        <th mat-header-cell *matHeaderCellDef>Assigned To</th>
        <td mat-cell *matCellDef="let t">
          <span [class.unassigned]="!t.assignedToName">
            {{t.assignedToName || 'Unassigned'}}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="dueDate">
        <th mat-header-cell *matHeaderCellDef>Due Date</th>
        <td mat-cell *matCellDef="let t" [class.overdue]="t.isOverdue">
          {{t.dueDate ? (t.dueDate | date:'short') : 'N/A'}}
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let t">
          <!-- Manager: Assign Ticket -->
          <button 
            *ngIf="isManager() && !t.assignedToId"
            mat-icon-button 
            color="primary"
            [matMenuTriggerFor]="assignMenu"
            matTooltip="Assign to Agent"
          >
            <mat-icon>person_add</mat-icon>
          </button>
          <mat-menu #assignMenu="matMenu">
            <button mat-menu-item *ngFor="let agent of agents" (click)="assignTicket(t.id, agent.id)">
              <mat-icon>person</mat-icon>
              {{agent.fullName}}
            </button>
          </mat-menu>

          <!-- View Details -->
          <button 
            mat-icon-button 
            [routerLink]="['/tickets', t.id]"
            matTooltip="View Details"
          >
            <mat-icon>visibility</mat-icon>
          </button>

          <!-- Agent: Start Work (if assigned to them) -->
          <button 
            *ngIf="!isManager() && t.assignedToId === currentUserId && t.status === 'Assigned'"
            mat-icon-button 
            color="accent"
            (click)="startWork(t.id)"
            matTooltip="Start Work"
          >
            <mat-icon>play_arrow</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator 
      [length]="total" 
      [pageSize]="size" 
      [pageSizeOptions]="[10,25,50]" 
      (page)="onPage($event)">
    </mat-paginator>
  </mat-card>
</div>